# Спецификация модуля запуска (Launching Module)

## Обзор

Модуль запуска представляет собой универсальный модульный шаблон для игр на движке Bevy. Он управляет начальными этапами приложения: от самого первого кадра до момента входа игрока в игровой мир.

Основная цель — предоставить стандартизированную структуру, которую можно легко переиспользовать в различных проектах (как 2D, так и 3D), сохраняя строгое разделение между системной логикой запуска и контентом конкретной игры.

## Обзор последовательности запуска

```plaintext
┌──────────────────────────────────────────────────────────────────────────────┐
│                            LAUNCH SEQUENCE FLOW                              │
├──────────────────────────────────────────────────────────────────────────────┤
│  Booting ───────► Splash ───────► MainMenu ───────► Loading ───────► InGame  │
│     │                │               │                 │                │    │
│     └─► Updates      └─► Shaders     ├─► Settings      └─► Assets       │    │
│     └─► Auth         └─► Hints       └─► Credits       └─► World        │    │
│                                                                         │    │
│                                InGame (Gameplay) ◄───► Paused           │    │
└──────────────────────────────────────────────────────────────────────────────┘
```

## Принципы проектирования

- **Модульность**: Реализовано как набор плагинов Bevy.
- **Управление состояниями**: Использует `States` Bevy для управления переходами между фазами.
- **Расширяемость**: Основные компоненты легко переопределяются или расширяются без изменения внутренней логики модуля.
- **Универсальная поддержка**: Базовая логика не зависит от типа рендеринга (2D или 3D). Компоненты интерфейса (Меню/Настройки) адаптируются под требования проекта (например, автоматически скрывают специфичные для 3D настройки графики в 2D играх).

## Последовательность запуска

Модуль управляет следующими состояниями:

1. **Boot (Загрузка системы)**:
    - Загрузка и валидация конфигурационных файлов (TOML/JSON).
    - Инициализация окна и графического движка.
    - Настройка глобальных ресурсов (логгер и т.д.).
    - **Проверка обновлений**: Проверка наличия новой версии приложения.
    - **Аутентификация**: Вход пользователя или восстановление сессии.
    - **Предкомпиляция шейдеров**: Загрузка и сборка необходимых шейдеров для предотвращения фризов во время игры.
2. **Splash (Заставки)**:
    - Отображение последовательности заставок (движок, студия, партнеры).
    - **Переходы**: Поддержка плавного появления и исчезновения (fade-in/fade-out).
    - **Прогресс и обратная связь**: Возможность видеть прогресс загрузки следующего состояния и случайные игровые советы/подсказки.
3. **MainMenu (Главное меню)**:
    - Стандартный интерфейс: "Начать игру", "Настройки", "Авторы", "Выход".
    - **Полные настройки**: Готовый GUI для всех параметров из `default.toml` (качество графики, сглаживание, VSync, громкость звука, переназначение клавиш).
    - **Адаптивный интерфейс**: Меню и настройки динамически меняют свой состав в зависимости от типа игры (2D или 3D), скрывая неактуальные опции.
    - **Расширяемость**: Конструкция позволяет легко добавлять/удалять пункты меню и менять стилизацию.
4. **Loading (Загрузка игры)**:
    - Асинхронная загрузка ассетов, необходимых для игрового мира или уровня.
    - Отображение детального прогресс-бара и статуса текущей задачи.
    - Переход в состояние `InGame`, когда все критические ресурсы готовы.

## Техническая архитектура

### Машина состояний

`AppState` (Перечисление):

- `Booting`: Системная инициализация, обновления и авторизация.
- `Splash`: Последовательность брендовых экранов.
- `MainMenu`: Взаимодействие и настройка.
- `Loading`: Подготовка игровых ресурсов.
- `InGame`: Активный геймплей (управляется внешней логикой игры).

### Плагины

- `BootPlugin`: Начальная настройка, проверка обновлений и логика аутентификации.
- `SplashPlugin`: Управление очередью заставок, индикаторами прогресса и системой подсказок.
- `MenuPlugin`: Основной функционал меню и подсистема настроек.
- `LoadingPlugin`: Оркестрация ресурсов через теги манифеста, отслеживание прогресса и переход в игру.

## Управление сценами через состояния (State-Driven Scene Management)

Проект следует стандарту «Профессионального игрового цикла», разделяя логику и данные с помощью **Состояний Bevy** и **Сцен**:

1. **Конечный автомат (FSM)**: `AppState` выступает в роли «мозга» приложения, контролируя жизненный цикл, очистку памяти (`OnExit`) и планирование работы систем.
2. **Scene Controller**: Каждое состояние управляет собственным контейнером данных (Сценой).
    - Вход в состояние инициирует асинхронную загрузку соответствующей сцены (макеты UI, освещение, фоновые ассеты).
    - Выход из состояния гарантирует эффективную выгрузку ресурсов.
3. **Разделение ответственности**: Логика (системы Rust) остается независимой от визуального представления (данные Сцены), что позволяет разработчикам и дизайнерам работать параллельно.

## Оркестрация ассетов (AAA подход)

Модуль использует **систему управления ассетами на основе манифестов** для обеспечения высокой производительности и масштабируемости:

- **Файл манифеста**: Все игровые ресурсы описаны во внешних манифестах (например, `assets/assets.toml`). Это позволяет менять ассеты без пересборки кода.
- **Пакеты и теги**: Ресурсы сгруппированы в логические пакеты, идентифицируемые тегами (например, `"Environment_Mars"`, `"Characters"`, `"Global_SFX"`).
- **Асинхронная оркестрация**:
  - `LoadingPlugin` интерпретирует теги, запрошенные игровой логикой (например, `loading_api.load_tag("Intro")`).
  - Автоматическая обработка зависимостей ресурсов.
  - Прогресс передается в виде нормализованного числа (0.0–1.0) и строки статуса для UI.
- **Оптимизированная загрузка**: Интеграция с асинхронным вводом-выводом и поддержка предварительной подготовки данных для GPU (шейдеры, текстуры).

### Конфигурация

Интеграция с `default.toml` для управления:

- Длительностью заставок.
- Пресетами стилей меню.
- Параметрами окна и разрешения.

## Пользовательские истории

- **Как разработчик**, я хочу подключить этот модуль к новому проекту и получить рабочее меню и экран загрузки за считанные минуты.
- **Как игрок**, я хочу видеть плавный переход от запуска исполняемого файла до появления главного меню.
- **Как разработчик**, я хочу легко добавлять свои кастомные заставки перед главным меню.
- **Как геймдизайнер**, я хочу добавлять новые ассеты на уровень, просто редактируя текстовый манифест, не касаясь кода логики загрузки.

## Будущие доработки

- Поддержка локализации.
- Поддержка контроллеров/геймпадов для меню "из коробки".
- Постоянное хранение пользовательских настроек.
